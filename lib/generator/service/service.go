package service

import (
	"bytes"
	"github.com/k0marov/gometa/lib/helpers"
	"github.com/k0marov/gometa/lib/schema"
	"io"
	"log"
	"text/template"
)

var serviceTemplate = template.Must(template.New("").Parse(`
package service

import (
    . "{{ .EntityImport }}"
)

type {{ .EntityName }}Repository interface {
    Create(entity *{{ .EntityName }}) (*{{.EntityName}}, error)
    Get(id uint64) (*{{ .EntityName }}, error) 
    Update(entity *{{ .EntityName }}) error 
    Delete(id uint64) error 
}

type {{ .EntityName }}ServiceImpl struct {
    repo {{ .EntityName }}Repository
}

func New{{ .EntityName }}ServiceImpl(repo {{ .EntityName }}Repository) *{{ .EntityName }}ServiceImpl {
    return &{{ .EntityName }}ServiceImpl{repo: repo}
}

func (s *{{ .EntityName }}ServiceImpl) Create(entity *{{ .EntityName }}) (*{{.EntityName}}, error) {
    // TODO: add business logic to {{ .EntityName }}Service.Create
    return s.repo.Create(entity)
}

func (s *{{ .EntityName }}ServiceImpl) Get(id uint64) (*{{ .EntityName }}, error) {
    entity, err := s.repo.Get(id)
    // TODO: add business logic to {{ .EntityName }}Service.Get
    return entity, err
}

func (s *{{ .EntityName }}ServiceImpl) Update(entity *{{ .EntityName }}) error {
    // TODO: add business logic to {{ .EntityName }}Service.Update
    return s.repo.Update(entity)
}

func (s *{{ .EntityName }}ServiceImpl) Delete(id uint64) error {
    // TODO: add business logic to {{ .EntityName }}Service.Delete
    return s.repo.Delete(id)
}
`))

// TODO: add returning id from Create

func Generate(ent schema.Entity, out io.Writer, entityImport string) {
	templateData := struct {
		EntityName   string
		EntityImport string
	}{
		EntityName:   ent.Name,
		EntityImport: entityImport,
	}
	var generated bytes.Buffer
	err := serviceTemplate.Execute(&generated, templateData)
	if err != nil {
		log.Fatalf("error while executing service template: %v", err)
	}
	if err := helpers.WriteFormatted(generated.Bytes(), out); err != nil {
		log.Fatalf("while formatting service file: %v", err)
	}
}
